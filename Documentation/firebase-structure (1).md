# Firebase Database Structure Documentation

## Overview
This document details the complete Firestore database schema for GETMY.MORTGAGE, including all collections, document structures, field definitions, and relationships.

## Collections Structure

### 1. `clients` Collection

Stores comprehensive client information gathered through the fact-find process.

#### Document ID
Auto-generated by Firebase

#### Fields

**Personal Information:**
- `firstName` (string): Client's first name
- `lastName` (string): Client's last name
- `email` (string): Contact email
- `phone` (string): Contact phone number
- `dateOfBirth` (date): Client's date of birth
- `createdAt` (timestamp): Record creation timestamp

**Financial Information:**
- `employmentStatus` (string): Current employment status
  - Values: "employed", "self-employed", "retired", "other"
- `annualIncome` (number): Annual gross income in GBP
- `monthlyCommitments` (number): Total monthly financial commitments

**Property Requirements:**
- `propertyValue` (number): Property purchase price or current value
- `depositAmount` (number): Available deposit amount
- `loanAmount` (number): Required mortgage amount (calculated: propertyValue - depositAmount)
- `ltv` (number): Loan-to-value percentage (calculated: (loanAmount/propertyValue) * 100)
- `propertyType` (string): Type of property
  - Values: "house", "flat", "bungalow", "other"
- `propertyUse` (string): Intended use
  - Values: "primary-residence", "buy-to-let", "second-home"

**Adverse Credit Information:**
- `hasCCJs` (boolean): Has County Court Judgments
- `ccjCount` (number): Number of CCJs (if hasCCJs = true)
- `ccjValue` (number): Total value of CCJs in GBP
- `ccjDate` (date): Date of most recent CCJ
- `ccjSatisfied` (boolean): Whether CCJs are satisfied

- `hasDefaults` (boolean): Has credit defaults
- `defaultCount` (number): Number of defaults
- `defaultValue` (number): Total value of defaults in GBP
- `defaultDate` (date): Date of most recent default

- `hasArrears` (boolean): Has mortgage/rent arrears
- `arrearsValue` (number): Value of arrears
- `arrearsDate` (date): Date of arrears

- `hasBankruptcy` (boolean): Has bankruptcy history
- `bankruptcyDate` (date): Date of bankruptcy discharge

- `hasIVA` (boolean): Has Individual Voluntary Arrangement
- `ivaDate` (date): Date IVA completed/started

- `hasDMP` (boolean): Has Debt Management Plan
- `dmpDate` (date): Date DMP started/completed

**Application Status:**
- `status` (string): Current application status
  - Values: "pending", "matched", "submitted", "approved", "declined"
- `lastUpdated` (timestamp): Last modification timestamp
- `matchedProducts` (array): Array of matched product references

#### Indexes
- Compound index: `status` + `createdAt` (for status-filtered queries)
- Single index: `email` (for lookup/duplicate checking)

---

### 2. `lenders` Collection

Stores lender information and metadata.

#### Document ID
Lender name in kebab-case (e.g., "pepper-money", "west-one")

#### Fields
- `name` (string): Display name of lender
- `active` (boolean): Whether lender is currently active
- `apiIntegration` (boolean): Has API integration capability
- `lastUpdated` (timestamp): Last data update timestamp
- `productCount` (number): Number of product tiers available
- `specializations` (array): Array of specialization strings
  - Examples: "adverse-credit", "self-employed", "buy-to-let"
- `contactInfo` (map):
  - `bdmName` (string): Business Development Manager name
  - `bdmEmail` (string): BDM email
  - `bdmPhone` (string): BDM phone
- `notes` (string): Additional notes about lender

#### Example Document
```
lenders/pepper-money
{
  name: "Pepper Money",
  active: true,
  apiIntegration: false,
  lastUpdated: [timestamp],
  productCount: 9,
  specializations: ["adverse-credit", "self-employed", "buy-to-let"],
  contactInfo: {
    bdmName: "John Smith",
    bdmEmail: "john.smith@peppermoney.com",
    bdmPhone: "0800 123 4567"
  },
  notes: "Specialist adverse credit lender"
}
```

---

### 3. `lenders/{lenderId}/products` Subcollection

Stores individual product tiers for each lender.

#### Document ID
Product code or tier identifier (e.g., "AAA", "tier-1-2yr-fix")

#### Core Product Fields
- `productName` (string): Display name
- `category` (string): Product category
  - Values: "residential", "buy-to-let", "bridging"
- `productType` (string): Specific type
  - Values: "purchase", "remortgage", "debt-consolidation"
- `rateType` (string): Interest rate type
  - Values: "fixed", "variable", "tracker", "discounted"
- `term` (number): Fixed rate term in years (if applicable)
- `rate` (number): Interest rate as decimal (e.g., 0.0549 for 5.49%)
- `aprc` (number): APRC as decimal
- `initialRate` (number): Initial rate for discounted products
- `revertRate` (number): Revert rate after initial period
- `productFee` (number): Lender product fee in GBP
- `maxLoanAmount` (number): Maximum loan amount in GBP
- `ltvBands` (array): Array of LTV band objects
  - Each object: `{ min: number, max: number, rate: number }`

#### Adverse Credit Criteria Object
Nested under `adverseCriteria` field:

```javascript
adverseCriteria: {
  ccjs: {
    allowed: boolean,
    maxCount: number,
    maxValue: number,
    monthsSinceMostRecent: number,
    maxInPeriod: number,  // max allowed in last 6 years
    minBalance: number,  // min outstanding balance (West One specific)
    periodYears: number,  // period for maxInPeriod check (typically 6)
    mustBeSatisfied: boolean
  },
  defaults: {
    allowed: boolean,
    maxCount: number,
    maxValue: number,
    monthsSinceMostRecent: number,
    maxInPeriod: number,
    minBalance: number,  // min outstanding balance (West One specific)
    periodYears: number,
    mustBeSatisfied: boolean
  },
  arrears: {
    allowed: boolean,
    maxValue: number,
    monthsSinceMostRecent: number
  },
  bankruptcy: {
    allowed: boolean,
    yearsSinceDischarge: number
  },
  iva: {
    allowed: boolean,
    yearsSinceCompletion: number
  },
  dmp: {
    allowed: boolean,
    yearsSinceCompletion: number
  }
}
```

#### Eligibility Criteria Object
Nested under `eligibility` field:

```javascript
eligibility: {
  minIncome: number,
  maxAge: number,
  minAge: number,
  employmentTypes: array,  // ["employed", "self-employed", "retired"]
  propertyTypes: array,  // ["house", "flat", "bungalow"]
  propertyUse: array,  // ["primary-residence", "buy-to-let"]
  minLoanAmount: number,
  maxLoanAmount: number,
  minLTV: number,
  maxLTV: number,
  minDepositPercent: number,
  regions: array  // ["england", "scotland", "wales", "northern-ireland"]
}
```

#### Product Metadata
- `active` (boolean): Product is currently available
- `lastUpdated` (timestamp): Last modification timestamp
- `source` (string): Source of rate information
- `importScriptUsed` (string): Name of import script used
- `notes` (string): Additional product notes

#### Example Complete Product Document
```
lenders/pepper-money/products/AAA
{
  productName: "Pepper AAA 2 Year Fixed",
  category: "residential",
  productType: "purchase",
  rateType: "fixed",
  term: 2,
  rate: 0.0549,
  aprc: 0.0573,
  revertRate: 0.0899,
  productFee: 1995,
  maxLoanAmount: 500000,
  
  adverseCriteria: {
    ccjs: {
      allowed: true,
      maxCount: 2,
      maxValue: 1000,
      monthsSinceMostRecent: 36,
      maxInPeriod: 2,
      periodYears: 6,
      mustBeSatisfied: true
    },
    defaults: {
      allowed: true,
      maxCount: 2,
      maxValue: 1000,
      monthsSinceMostRecent: 36,
      maxInPeriod: 2,
      periodYears: 6,
      mustBeSatisfied: true
    },
    arrears: {
      allowed: false,
      maxValue: 0,
      monthsSinceMostRecent: 0
    },
    bankruptcy: {
      allowed: false,
      yearsSinceDischarge: 0
    },
    iva: {
      allowed: false,
      yearsSinceCompletion: 0
    },
    dmp: {
      allowed: false,
      yearsSinceCompletion: 0
    }
  },
  
  eligibility: {
    minIncome: 25000,
    maxAge: 70,
    minAge: 21,
    employmentTypes: ["employed", "self-employed"],
    propertyTypes: ["house", "flat", "bungalow"],
    propertyUse: ["primary-residence"],
    minLoanAmount: 25000,
    maxLoanAmount: 500000,
    minLTV: 60,
    maxLTV: 90,
    minDepositPercent: 10,
    regions: ["england", "scotland", "wales"]
  },
  
  active: true,
  lastUpdated: [timestamp],
  source: "Pepper Money Rate Card 2024",
  importScriptUsed: "import-pepper-AAA.js",
  notes: "Top tier product for minimal adverse credit"
}
```

---

## Field Naming Conventions

### General Rules
1. Use camelCase for all field names
2. Use descriptive names that clearly indicate purpose
3. Use consistent prefixes for related fields:
   - `has` prefix for boolean flags (hasCCJs, hasDefaults)
   - `count` suffix for numeric counts (ccjCount, defaultCount)
   - `date` suffix for date fields (ccjDate, defaultDate)
   - `min`/`max` prefixes for range values (minIncome, maxLTV)

### Adverse Credit Field Mapping
Client fields map to product criteria as follows:

| Client Field | Product Criteria Path | Comparison |
|--------------|----------------------|------------|
| `hasCCJs` | `adverseCriteria.ccjs.allowed` | Must be true if client has CCJs |
| `ccjCount` | `adverseCriteria.ccjs.maxCount` | Client value ≤ product max |
| `ccjValue` | `adverseCriteria.ccjs.maxValue` | Client value ≤ product max |
| `ccjDate` | `adverseCriteria.ccjs.monthsSinceMostRecent` | Months between ≥ required |
| `ccjSatisfied` | `adverseCriteria.ccjs.mustBeSatisfied` | Must match if required |

(Similar patterns apply for defaults, arrears, bankruptcy, IVA, DMP)

### Special Field Handling

**West One minBalance:**
- Only applies when client has 1 adverse event
- If client has 1 CCJ: `ccjValue` must be ≥ `adverseCriteria.ccjs.minBalance`
- If client has 1 default: `defaultValue` must be ≥ `adverseCriteria.defaults.minBalance`
- If minBalance not present, check is skipped

**Date Calculations:**
- All date comparisons calculate months elapsed from adverse event date to current date
- Example: Client CCJ date = "2020-01-15", Current = "2024-01-15" → 48 months elapsed
- Product requires `monthsSinceMostRecent: 36` → Client qualifies (48 ≥ 36)

**LTV Calculations:**
- Always calculated as: `(loanAmount / propertyValue) * 100`
- Rounded to 2 decimal places
- Compared against product's `minLTV` and `maxLTV` ranges

---

## Data Validation Rules

### Client Data Validation
1. Email must be valid format and unique
2. LTV must be between 0 and 100
3. If adverse credit flag is true, corresponding count/value/date must be present
4. Income must be positive number
5. Property value and deposit must result in positive loan amount

### Product Data Validation
1. Rate, APRC, and revert rate must be valid decimals (0.0000 to 1.0000)
2. If adverse criterion allowed = false, all related max values must be 0
3. LTV bands must not overlap and must cover full range offered
4. Min values must be less than or equal to max values
5. Date requirements (monthsSince, yearsSince) must be non-negative

---

## Indexing Strategy

### Required Indexes

**clients collection:**
```
- email (single field, ascending)
- status (single field, ascending)
- createdAt (single field, descending)
- status + createdAt (composite, status ascending, createdAt descending)
```

**products subcollections:**
```
- active (single field, ascending)
- category (single field, ascending)
- rate (single field, ascending)
- adverseCriteria.ccjs.allowed (single field, ascending)
- adverseCriteria.defaults.allowed (single field, ascending)
```

### Query Performance Notes
- Product matching queries scan all active products (typically <100 per lender)
- Client lookups by email are indexed for fast retrieval
- Status-based dashboard queries use composite index for optimal performance

---

## Data Migration Considerations

### Adding New Lenders
1. Create lender document in `lenders` collection
2. Import products using consistent script naming: `import-{lender}-{tier}.js`
3. Ensure all products follow field structure exactly
4. Test with sample client data before activating
5. Update lender's `productCount` field after import

### Schema Changes
When adding new fields:
1. Add to this documentation first
2. Create migration script for existing documents
3. Update matching engine logic if needed
4. Update validation rules
5. Test thoroughly with existing data

### Handling Historical Data
- Never delete client data (GDPR requires retention controls)
- Mark products as `active: false` rather than deleting
- Maintain `lastUpdated` timestamps for audit trails
- Archive old product versions if rates change

---

## Security Rules Considerations

### Recommended Firestore Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Clients - authenticated users can only access their own data
    match /clients/{clientId} {
      allow read, write: if request.auth != null && request.auth.uid == clientId;
    }
    
    // Lenders - read-only for authenticated users
    match /lenders/{lenderId} {
      allow read: if request.auth != null;
      allow write: if false; // Only via admin SDK
      
      // Products - read-only for authenticated users
      match /products/{productId} {
        allow read: if request.auth != null;
        allow write: if false; // Only via admin SDK
      }
    }
  }
}
```

---

## Backup and Recovery

### Backup Strategy
- Daily automated Firestore backups
- Export client data weekly to encrypted storage
- Version control all import scripts
- Maintain rate card PDFs as source of truth

### Recovery Procedures
1. Client data: Restore from daily backup
2. Product data: Re-run import scripts from source documents
3. Lender data: Restore from backup or recreate from documentation

---

## Future Enhancements

### Planned Schema Changes
1. Add `applications` collection for formal mortgage applications
2. Add `documents` subcollection to clients for uploaded files
3. Add `audit_log` collection for compliance tracking
4. Add `rate_history` to track product rate changes over time

### Optimization Opportunities
1. Implement caching layer for frequently accessed products
2. Add materialized views for common client segments
3. Consider denormalization for dashboard queries
4. Evaluate partitioning strategy as data grows

---

## Version History

**Version 1.0** (Current)
- Initial database schema
- 4 lenders with 34 product tiers
- Core adverse credit criteria structure
- Client fact-find data model

**Planned Version 1.1**
- Add applications collection
- Add document storage structure
- Add audit logging
- Enhanced criteria for complex scenarios (e.g., satisfied vs registered CCJs)

---

## Related Documentation
- See `import-scripts-inventory.md` for details on data import
- See `matching-engine-docs.md` for how this data is used in matching
- See `strategic-decisions.md` for rationale behind schema design choices
